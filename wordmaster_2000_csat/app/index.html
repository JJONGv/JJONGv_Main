<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ë‹¨ì–´ ë­í‚¹ ê²Œì„(ì›Œë§ˆ ê³ ë“±Basic)</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ê¸°ë³¸ ì ìš© */
        body, input, button {
            font-family: 'Inter', sans-serif;
        }
        /* íƒ€ì´ë¨¸ ë°” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes shrink {
            from { width: 100%; }
            to { width: 0%; }
        }
        .timer-bar-animate {
            /* 7ì´ˆ */
            animation: shrink 7s linear forwards;
        }
        /* ë²„íŠ¼ í´ë¦­ ì‹œ í”¼ë“œë°± */
        .btn-correct {
            animation: flash-green 0.5s;
        }
        .btn-wrong {
            animation: flash-red 0.5s;
        }
        @keyframes flash-green {
            0%, 100% { background-color: #22c55e; transform: scale(1); } /* green-500 */
            50% { transform: scale(1.05); }
        }
        @keyframes flash-red {
            0%, 100% { background-color: #ef4444; transform: scale(1); } /* red-500 */
            50% { transform: scale(1.05); }
        }
        /* í™”ë©´ ì „í™˜ íš¨ê³¼ */
        .screen {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute; /* hiddenì¼ ë•Œ ë ˆì´ì•„ì›ƒì—ì„œ ì œì™¸ */
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <!-- ì•Œë¦¼ì°½ (ì˜¤ë¥˜, ì„±ê³µ, ì¼ë°˜) -->
    <div id="message-box" class="hidden fixed top-5 left-1/2 -translate-x-1/2 w-11/12 max-w-md" role="alert">
        <strong id="message-title" class="font-bold"></strong>
        <span id="message-body" class="block sm:inline"></span>
    </div>

    <!-- [ë ˆì´ì•„ì›ƒ ìˆ˜ì •] shadow-2xl -> shadow-xl -->
    <div class="w-full max-w-md mx-auto bg-white shadow-xl rounded-2xl p-6 relative overflow-hidden">

        <!-- 0. ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-75 flex flex-col items-center justify-center z-50">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-text" class="text-indigo-600 font-semibold mt-2">ì´ˆê¸°í™” ì¤‘...</span>
        </div>

        <!-- 1. ì‹œì‘ í™”ë©´ -->
        <div id="start-screen" class="screen text-center">
            <h1 class="text-3xl font-bold text-indigo-600 mb-4">ì˜ë‹¨ì–´ ë­í‚¹ ê²Œì„</h1>
            <p class="text-gray-600 mb-6">ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ë„ì „í•  Dayë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            
            <div class="mb-4">
                <label for="nickname-input" class="block text-sm font-medium text-gray-700 text-left mb-1">ë‹‰ë„¤ì„</label>
                <input type="text" id="nickname-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <div class="mb-6">
                <label for="day-select" class="block text-sm font-medium text-gray-700 text-left mb-1">Day ì„ íƒ</label>
                <select id="day-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" disabled>
                    <option value="">ë‹¨ì–´ì¥ ë¡œë“œ ì¤‘...</option>
                </select>
            </div>

            <!-- [ë ˆì´ì•„ì›ƒ ìˆ˜ì •] disabled: pseudo-classë¡œ ìƒíƒœ ê´€ë¦¬ -->
            <button id="start-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                ê²Œì„ ì‹œì‘
            </button>
            
            <!-- ì‹¤ì‹œê°„ ë¦¬ë”ë³´ë“œ -->
            <div class="mt-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-3 text-left">ğŸ”¥ì‹¤ì‹œê°„ í”Œë ˆì´ í˜„í™©</h3>
                <div id="leaderboard-loading" class="text-gray-500">ë¦¬ë”ë³´ë“œ ë¡œë“œ ì¤‘...</div>
                <ul id="leaderboard-list" class="h-48 overflow-y-auto bg-gray-50 p-3 rounded-lg text-left text-sm space-y-2">
                    <!-- ë¦¬ë”ë³´ë“œ ì•„ì´í…œì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </ul>
            </div>
            
            <!-- ê´€ë¦¬ì ëª¨ë“œ -->
            <div class="mt-4 text-left">
                <button id="admin-mode-button" class="text-xs text-gray-400 hover:text-indigo-600">ê´€ë¦¬ì ëª¨ë“œ</button>
            </div>
            <div id="admin-panel" class="hidden mt-4 p-4 bg-gray-100 rounded-lg">
                <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="admin-password" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                <button id="admin-submit-button" class="w-full mt-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                    ë¦¬ë”ë³´ë“œ ê¸°ë¡ ì‚­ì œ
                </button>
            </div>

        </div>

        <!-- 2. ê²Œì„ ì¤‘ í™”ë©´ -->
        <div id="game-screen" class="screen hidden">
            <!-- í—¤ë”: ë§ì¶˜ ê°œìˆ˜ì™€ ìƒëª… -->
            <div class="flex justify-between items-center mb-4">
                <div class="text-lg">
                    <span class="font-bold text-indigo-600">ë§ì¶˜ ê°œìˆ˜</span>
                    <span id="score" class="text-2xl font-bold ml-2">0 / 0</span>
                </div>
                <div id="lives" class="flex space-x-1">
                    <!-- í•˜íŠ¸ ì•„ì´ì½˜ -->
                </div>
            </div>

            <!-- íƒ€ì´ë¨¸ ë°” -->
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6 overflow-hidden">
                <div id="timer-bar" class="bg-green-500 h-2.5 rounded-full"></div>
            </div>

            <!-- [ë ˆì´ì•„ì›ƒ ìˆ˜ì •] ê³ ì • ë†’ì´ h-20 ì œê±° -> min-h-[5rem] ì ìš© -->
            <div class="text-center mb-8 min-h-[5rem] flex items-center justify-center">
                <h2 id="question-word" class="text-4xl font-bold text-gray-800 break-all">apple</h2>
            </div>

            <!-- [ë ˆì´ì•„ì›ƒ ìˆ˜ì •] ê³ ì • ë†’ì´ h-24 ì œê±° -> min-h-24 ì ìš©, border ë° hover íš¨ê³¼ ì¶”ê°€ -->
            <div id="options-grid" class="grid grid-cols-2 gap-4">
                <button class="option-btn min-h-24 border border-gray-200 bg-gray-100 hover:bg-indigo-50 hover:border-indigo-300 text-gray-800 font-semibold py-4 px-4 rounded-lg text-lg transition-transform duration-200 hover:scale-105"></button>
                <button class="option-btn min-h-24 border border-gray-200 bg-gray-100 hover:bg-indigo-50 hover:border-indigo-300 text-gray-800 font-semibold py-4 px-4 rounded-lg text-lg transition-transform duration-200 hover:scale-105"></button>
                <button class="option-btn min-h-24 border border-gray-200 bg-gray-100 hover:bg-indigo-50 hover:border-indigo-300 text-gray-800 font-semibold py-4 px-4 rounded-lg text-lg transition-transform duration-200 hover:scale-105"></button>
                <button class="option-btn min-h-24 border border-gray-200 bg-gray-100 hover:bg-indigo-50 hover:border-indigo-300 text-gray-800 font-semibold py-4 px-4 rounded-lg text-lg transition-transform duration-200 hover:scale-105"></button>
            </div>
        </div>

        <!-- 3. ê²Œì„ ì˜¤ë²„ í™”ë©´ -->
        <div id="game-over-screen" class="screen hidden text-center">
            <h2 id="game-over-title" class="text-3xl font-bold text-red-600 mb-4">ê²Œì„ ì˜¤ë²„!</h2>
            <p class="text-gray-600 text-xl mb-6">
                ìµœì¢… ê²°ê³¼: <span id="final-score" class="font-bold text-2xl">0 / 0</span>
            </p>
            <button id="restart-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform duration-200 hover:scale-105">
                Day ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>

    <!-- Firebase SDK (ESM - ëª¨ë“ˆ íƒ€ì…) -->
    <script type="module">
        // --- 1. Firebase SDK ëª¨ë“ˆ ê°€ì ¸ì˜¤ê¸° ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            limit, 
            onSnapshot, 
            serverTimestamp,
            getDocs,
            deleteDoc,
            writeBatch,
            doc,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 2. Google Sheet ë° ì „ì—­ ë³€ìˆ˜ ì„¤ì • ---
        
        // (ì„¤ì • ìœ ì§€) Google Sheet "ì›¹ì— ê²Œì‹œ" -> "CSV" ë§í¬
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQU4mlCRTqgUmcZa_Fr28WUomiGWmGTR18WwHXJpwfNhx43Iejb1CA2Jg-pOFgrFbBztWEMOj9HR8-i/pub?output=csv";
        
        const ADMIN_PASSWORD = "5k6m1o20";

        // Firebase ê´€ë ¨
        let db, auth;
        let userId;
        let isAuthReady = false; 

        // ë‹¨ì–´ì¥ ë°ì´í„°
        let wordsByDay = {}; // { "Day 01": [{en, ko, isMultiWord}, ...], "Day 02": [...] }
        let allWordsList = []; // ëª¨ë“  Dayì˜ ë‹¨ì–´ ê°ì²´ ë¦¬ìŠ¤íŠ¸
        let selectedDay = "";
        let selectedDayWords = []; // í˜„ì¬ ì„ íƒëœ Dayì˜ ì „ì²´ ë‹¨ì–´ ëª©ë¡
        let questionsForDay = []; // í˜„ì¬ ê²Œì„ì—ì„œ í’€ ë¬¸ì œ ëª©ë¡ (ëœë¤ ì…”í”Œë¨)

        // [íš¨ìœ¨í™”] ê²Œì„ ìƒíƒœë¥¼ ê°ì²´ë¡œ ê·¸ë£¹í™”
        const gameState = {
            score: 0,
            lives: 3,
            isClickable: true
        };
        let currentWord = null; // [íš¨ìœ¨í™”] í˜„ì¬ ë‹¨ì–´ ì €ì¥ (find() ì¤‘ë³µ ë°©ì§€)
        let timerId; 
        let currentNickname = "";

        // DOM ìš”ì†Œ
        const DOM = {};

        // --- 3. DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™” ---
        window.addEventListener('DOMContentLoaded', () => {
            // DOM ìš”ì†Œë“¤ ìºì‹±
            Object.assign(DOM, {
                loadingOverlay: document.getElementById('loading-overlay'),
                loadingText: document.getElementById('loading-text'),
                messageBox: document.getElementById('message-box'),
                messageTitle: document.getElementById('message-title'),
                messageBody: document.getElementById('message-body'),
                
                startScreen: document.getElementById('start-screen'),
                gameScreen: document.getElementById('game-screen'),
                gameOverScreen: document.getElementById('game-over-screen'),
                
                nicknameInput: document.getElementById('nickname-input'),
                daySelect: document.getElementById('day-select'),
                startButton: document.getElementById('start-button'),
                restartButton: document.getElementById('restart-button'),
                
                scoreDisplay: document.getElementById('score'),
                livesDisplay: document.getElementById('lives'),
                timerBar: document.getElementById('timer-bar'),
                questionWord: document.getElementById('question-word'),
                optionsGrid: document.getElementById('options-grid'),
                optionButtons: document.querySelectorAll('.option-btn'),
                
                finalScore: document.getElementById('final-score'),
                gameOverTitle: document.getElementById('game-over-title'),
                
                leaderboardLoading: document.getElementById('leaderboard-loading'),
                leaderboardList: document.getElementById('leaderboard-list'),
                
                adminModeButton: document.getElementById('admin-mode-button'),
                adminPanel: document.getElementById('admin-panel'),
                adminPassword: document.getElementById('admin-password'),
                adminSubmitButton: document.getElementById('admin-submit-button')
            });

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”©
            DOM.startButton.addEventListener('click', startGame);
            DOM.restartButton.addEventListener('click', () => showScreen('start'));
            DOM.optionButtons.forEach(button => {
                button.addEventListener('click', checkAnswer);
            });
            DOM.adminModeButton.addEventListener('click', () => {
                DOM.adminPanel.classList.toggle('hidden');
            });
            DOM.adminSubmitButton.addEventListener('click', handleAdminClear);
            
            DOM.daySelect.addEventListener('change', checkStartButton);
            DOM.nicknameInput.addEventListener('input', checkStartButton);

            // ì•± ì‹¤í–‰
            initializeFirebaseAndLoadData();
        });
        
        // --- 4. ì´ˆê¸°í™” í•¨ìˆ˜ ---

        async function initializeFirebaseAndLoadData() {
            showScreen('start'); // ìš°ì„  ì‹œì‘ í™”ë©´ í‘œì‹œ
            DOM.loadingText.textContent = "Firebase ì—°ê²° ì¤‘...";
            
            try {
                await initializeFirebase();
                // Firebase ì¸ì¦ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                await whenAuthReady(); 
                
                DOM.loadingText.textContent = "ë¦¬ë”ë³´ë“œ ë¡œë“œ ì¤‘...";
                loadLeaderboard(); // ë¦¬ë”ë³´ë“œ ì‹¤ì‹œê°„ ê°ì‹œ ì‹œì‘

                DOM.loadingText.textContent = "ë‹¨ì–´ì¥ ë¡œë“œ ì¤‘...";
                await loadWordsFromGoogleSheet();
                
                DOM.loadingOverlay.classList.add('hidden'); // ëª¨ë“  ë¡œë”© ì™„ë£Œ
                
            } catch (error) {
                console.error("ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                showError(error.message);
                DOM.loadingText.textContent = "ì´ˆê¸°í™” ì‹¤íŒ¨";
            }
        }
        
        async function initializeFirebase() {
            // (ì„¤ì • ìœ ì§€) GitHub í™˜ê²½ìš© Firebase config
            const firebaseConfig = {
                apiKey: "AIzaSyDrrf9SIBjAnLtd0zvfTlCfPTKi-QsYJMg",
                authDomain: "word-game-7ff9b.firebaseapp.com",
                projectId: "word-game-7ff9b",
                storageBucket: "word-game-7ff9b.firebasestorage.app",
                messagingSenderId: "284686212123",
                appId: "1:284686212123:web:41bf7bb78fd8fb5d2e2cbe"
            };

            // GitHub í™˜ê²½ì¸ì§€ í™•ì¸
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                const errorMsg = "Firebase ì„¤ì •(config)ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. (GitHub í™˜ê²½)";
                showError(errorMsg);
                throw new Error(errorMsg);
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                setLogLevel('Debug');

                // ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true; // ì¸ì¦ ì„±ê³µ!
                        console.log("Firebase ì¸ì¦ ì„±ê³µ (ìµëª…):", userId);
                    }
                });

                // Firebase ìµëª… ë¡œê·¸ì¸ ì‹œë„
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                throw new Error("Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            }
        }
        
        // ì¸ì¦ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” Promise
        function whenAuthReady() {
            return new Promise((resolve) => {
                if (isAuthReady) {
                    resolve();
                } else {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            unsubscribe();
                            resolve();
                        }
                    });
                }
            });
        }

        // --- 5. Google Sheet ë°ì´í„° ë¡œë“œ ë° ì²˜ë¦¬ ---

        async function loadWordsFromGoogleSheet() {
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error(`Google Sheet ë¡œë“œ ì‹¤íŒ¨ (HTTP ${response.status})`);
                }
                const csvData = await response.text();
                parseCSV(csvData);
                populateDaySelect();
            } catch (error) {
                console.error("Google Sheet ë¡œë“œ ì˜¤ë¥˜:", error);
                showError("ë‹¨ì–´ì¥ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. Google Sheet URL ë˜ëŠ” 'ì›¹ì— ê²Œì‹œ' ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        function parseCSV(csvData) {
            wordsByDay = {};
            allWordsList = [];
            const rows = csvData.trim().split('\n');

            rows.forEach(row => {
                const parts = [];
                let inQuotes = false;
                let currentPart = '';

                // Cì—´ì— ì‰¼í‘œ(,)ê°€ í¬í•¨ëœ ê²½ìš°("A, B")ë¥¼ ì²˜ë¦¬í•˜ëŠ” íŒŒì„œ
                for (let i = 0; i < row.length; i++) {
                    const char = row[i];
                    if (char === '"' && (i === 0 || row[i-1] !== '\\')) {
                        inQuotes = !inQuotes;
                        continue; // ë”°ì˜´í‘œ ìì²´ëŠ” ì €ì¥í•˜ì§€ ì•ŠìŒ
                    }
                    if (char === ',' && !inQuotes) {
                        parts.push(currentPart.trim());
                        currentPart = '';
                        continue;
                    }
                    currentPart += char;
                }
                parts.push(currentPart.trim()); // ë§ˆì§€ë§‰ ë¶€ë¶„ ì¶”ê°€

                if (parts.length === 3) {
                    const [day, en, ko] = parts.map(part => part.replace(/^"|"$/g, '').replace(/\\"/g, '"').trim());
                    
                    if (day && en && ko) {
                        const isMultiWord = en.includes(' '); // ë‹¨ì–´ ìœ í˜• (true/false)
                        const wordData = { en, ko, isMultiWord };

                        if (!wordsByDay[day]) {
                            wordsByDay[day] = [];
                        }
                        wordsByDay[day].push(wordData);
                        allWordsList.push({ day, en, ko, isMultiWord });
                    }
                }
            });
            console.log("ë‹¨ì–´ì¥ íŒŒì‹± ì™„ë£Œ:", wordsByDay);
        }

        function populateDaySelect() {
            const dayKeys = Object.keys(wordsByDay).sort();
            if (dayKeys.length === 0) {
                DOM.daySelect.innerHTML = '<option value="">ë‹¨ì–´ì¥ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</option>';
                showError("ë¡œë“œëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. Google Sheet ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.");
                return;
            }

            DOM.daySelect.innerHTML = '<option value="">-- Dayë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
            dayKeys.forEach(day => {
                const count = wordsByDay[day].length;
                // 4ì§€ì„ ë‹¤ êµ¬ì„±ì´ ê°€ëŠ¥í•œ 4ê°œ ì´ìƒì˜ ë‹¨ì–´ê°€ ìˆëŠ” Dayë§Œ ì¶”ê°€
                if (count >= 4) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = `${day} (ì´ ${count} ë‹¨ì–´)`;
                    DOM.daySelect.appendChild(option);
                }
            });
            DOM.daySelect.disabled = false;
        }
        
        // --- 6. ë¦¬ë”ë³´ë“œ (Firestore) ---

        function loadLeaderboard() {
            if (!db || !isAuthReady) {
                console.warn("loadLeaderboard: Firestore ì¤€ë¹„ ì•ˆë¨");
                DOM.leaderboardLoading.textContent = "Firebase ì—°ê²° ì‹¤íŒ¨";
                return;
            }

            const collectionPath = "leaderboard";
            const q = query(collection(db, collectionPath), orderBy("timestamp", "desc"), limit(20));

            onSnapshot(q, (snapshot) => {
                const records = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // ë°©ì–´ ì½”ë“œ: timestampê°€ ìœ íš¨í•œ ë°ì´í„°ë§Œ í•„í„°ë§
                    if (data.timestamp) {
                        records.push(data);
                    }
                });
                
                // (ë°©ì–´ ì½”ë“œ) í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì •ë ¬
                records.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return timeB - timeA;
                });

                displayLeaderboard(records);

            }, (error) => {
                console.error("ë¦¬ë”ë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:", error);
                showError("ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                DOM.leaderboardLoading.textContent = "ë¦¬ë”ë³´ë“œ ë¡œë“œ ì‹¤íŒ¨";
            });
        }

        function displayLeaderboard(records) {
            DOM.leaderboardList.innerHTML = ''; // ëª©ë¡ ì´ˆê¸°í™”
            if (records.length === 0) {
                DOM.leaderboardLoading.classList.add('hidden');
                DOM.leaderboardList.innerHTML = '<li class="text-gray-500">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }

            DOM.leaderboardLoading.classList.add('hidden');
            records.forEach(record => {
                const li = document.createElement('li');
                li.className = "border-b border-gray-200 pb-2";
                
                // (ë°©ì–´ ì½”ë“œ) timestampê°€ ìœ íš¨í•œì§€ ë‹¤ì‹œ í™•ì¸
                const timeAgo = (record.timestamp && typeof record.timestamp.toDate === 'function') 
                                ? formatTimeAgo(record.timestamp.toDate()) 
                                : 'ë°©ê¸ˆ ì „';
                
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-indigo-700">${record.nickname || 'ìµëª…'}</span>
                        <span class="font-bold text-gray-800">${record.scoreString || '0 / 0'}</span>
                    </div>
                    <div class="flex justify-between items-center text-gray-500">
                        <span>(${record.day || 'Day ??'})</span>
                        <span>${timeAgo}</span>
                    </div>
                `;
                DOM.leaderboardList.appendChild(li);
            });
        }

        async function saveScoreToLeaderboard() {
            if (!db || !isAuthReady) {
                showError("Firebase ì—°ê²°ì´ ëŠì–´ì ¸ ì ìˆ˜ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // [íš¨ìœ¨í™”] gameState ê°ì²´ ì‚¬ìš©
            const scoreStr = `${gameState.score} / ${selectedDayWords.length}`;
            const collectionPath = "leaderboard";
            
            const docData = {
                nickname: currentNickname,
                day: selectedDay,
                score: gameState.score, // ìˆ«ì ì ìˆ˜ (ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì§‘ê³„ìš©)
                total: selectedDayWords.length,
                scoreString: scoreStr,
                timestamp: serverTimestamp(),
                userId: userId
            };

            try {
                await addDoc(collection(db, collectionPath), docData);
                console.log("ì ìˆ˜ ì €ì¥ ì„±ê³µ:", docData);
            } catch (error) {
                console.error("ì ìˆ˜ ì €ì¥ ì˜¤ë¥˜:", error);
                showError("ì ìˆ˜ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // --- 7. ê²Œì„ ë¡œì§ ---

        function checkStartButton() {
            const daySelected = DOM.daySelect.value !== "";
            const nicknameEntered = DOM.nicknameInput.value.trim() !== "";
            
            // [íš¨ìœ¨í™”] JavaScriptì—ì„œ classListë¥¼ ì¡°ì‘í•˜ëŠ” ëŒ€ì‹  'disabled' ì†ì„±ë§Œ ì œì–´
            DOM.startButton.disabled = !(daySelected && nicknameEntered);
        }
        
        function startGame() {
            selectedDay = DOM.daySelect.value;
            currentNickname = DOM.nicknameInput.value.trim();
            
            if (!selectedDay || !currentNickname) {
                showError("ë‹‰ë„¤ì„ê³¼ Dayë¥¼ ëª¨ë‘ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }
            
            selectedDayWords = wordsByDay[selectedDay] || [];
            if (selectedDayWords.length < 4) {
                showError("ë‹¨ì–´ ìˆ˜ê°€ 4ê°œ ë¯¸ë§Œì´ë¼ í€´ì¦ˆë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            // ë¬¸ì œ ëª©ë¡ ìƒì„± ë° ì…”í”Œ
            questionsForDay = [...selectedDayWords];
            shuffleArray(questionsForDay);

            // [íš¨ìœ¨í™”] gameState ê°ì²´ ì´ˆê¸°í™”
            gameState.score = 0;
            gameState.lives = 3;
            gameState.isClickable = true;
            currentWord = null;
            
            updateScoreAndLives();
            nextQuestion();
            showScreen('game');
        }

        function nextQuestion() {
            if (questionsForDay.length === 0) {
                // ëª¨ë“  ë¬¸ì œ ì™„ë£Œ
                gameOver(true);
                return;
            }

            currentWord = questionsForDay.pop(); // [íš¨ìœ¨í™”] í˜„ì¬ ë‹¨ì–´ ì €ì¥
            
            // 1. ë¬¸ì œ(ì˜ì–´) ì„¤ì •
            DOM.questionWord.textContent = currentWord.en;

            // 2. ì„ íƒì§€(í•œê¸€) ìƒì„±
            const options = generateOptions(currentWord.ko, currentWord.isMultiWord);

            // 3. ì„ íƒì§€ ë²„íŠ¼ì— ì„¤ì •
            DOM.optionButtons.forEach((button, index) => {
                button.textContent = options[index];
                button.dataset.answer = options[index]; // ì •ë‹µ í™•ì¸ì„ ìœ„í•´ ë°ì´í„° ì €ì¥
                
                // ì´ì „ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                button.disabled = false;
                // [ë ˆì´ì•„ì›ƒ ìˆ˜ì •] className í•˜ë“œì½”ë”© (ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì œê±°)
                button.className = 'option-btn min-h-24 border border-gray-200 bg-gray-100 hover:bg-indigo-50 hover:border-indigo-300 text-gray-800 font-semibold py-4 px-4 rounded-lg text-lg transition-transform duration-200 hover:scale-105';
            });
            
            gameState.isClickable = true;
            startTimer();
        }

        // 4ê°œì˜ ì„ íƒì§€ ìƒì„± (ì •ë‹µ 1 + ì˜¤ë‹µ 3)
        function generateOptions(correctKoreanAnswer, isMultiWord) {
            const options = new Set([correctKoreanAnswer]);
            
            // 1. í˜„ì¬ Dayì˜ í•œê¸€ ëœ» ëª©ë¡ (ì˜¤ë‹µ ì œì™¸ìš©)
            const currentDayKoSet = new Set(selectedDayWords.map(w => w.ko));

            // 2. 'ë‹¤ë¥¸ Day' ë‹¨ì–´ ëª©ë¡ (ì˜¤ë‹µ í’€)
            const otherDayWords = allWordsList.filter(word => 
                !currentDayKoSet.has(word.ko)
            );

            // 3. ì˜¤ë‹µ í’€ì„ 'ìœ í˜•'ì— ë”°ë¼ ë¶„ë¦¬
            const sameTypePool = otherDayWords.filter(word => word.isMultiWord === isMultiWord);
            const differentTypePool = otherDayWords.filter(word => word.isMultiWord !== isMultiWord);
            
            shuffleArray(sameTypePool);
            shuffleArray(differentTypePool);

            // 4. ì„ ì§€ ì±„ìš°ê¸° (1ìˆœìœ„: ë‹¤ë¥¸ Day + ê°™ì€ ìœ í˜•)
            while (options.size < 4 && sameTypePool.length > 0) {
                options.add(sameTypePool.pop().ko);
            }

            // 5. ì„ ì§€ ì±„ìš°ê¸° (2ìˆœìœ„: ë‹¤ë¥¸ Day + ë‹¤ë¥¸ ìœ í˜•)
            while (options.size < 4 && differentTypePool.length > 0) {
                options.add(differentTypePool.pop().ko);
            }

            // 6. ì„ ì§€ ì±„ìš°ê¸° (3ìˆœìœ„: Fallback - ëª¨ë“  ë‹¨ì–´)
            const fallbackPool = allWordsList.filter(word => !options.has(word.ko));
            shuffleArray(fallbackPool);
            while (options.size < 4 && fallbackPool.length > 0) {
                options.add(fallbackPool.pop().ko);
            }
            
            const finalOptions = Array.from(options);
            shuffleArray(finalOptions); // ì •ë‹µê³¼ ì˜¤ë‹µ ì„ê¸°
            return finalOptions.slice(0, 4); // 4ê°œ ë³´ì¥
        }


        function startTimer() {
            clearTimeout(timerId); // ì´ì „ íƒ€ì´ë¨¸ ì·¨ì†Œ
            
            // íƒ€ì´ë¨¸ ë°” ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘ (Reflow íŠ¸ë¦­)
            DOM.timerBar.classList.remove('timer-bar-animate');
            void DOM.timerBar.offsetWidth; 
            DOM.timerBar.classList.add('timer-bar-animate');
            DOM.timerBar.style.backgroundColor = '#22c55e'; // green-500

            // 7ì´ˆ íƒ€ì´ë¨¸
            timerId = setTimeout(() => {
                if (gameState.isClickable) { 
                    handleAnswer(false, null); // ì‹œê°„ ì´ˆê³¼ = ì˜¤ë‹µ
                }
            }, 7000); // 7ì´ˆ
        }

        function checkAnswer(event) {
            if (!gameState.isClickable) return; 
            gameState.isClickable = false;
            
            clearTimeout(timerId); 
            DOM.timerBar.classList.remove('timer-bar-animate');

            const selectedButton = event.target;
            const selectedAnswer = selectedButton.dataset.answer;
            
            // [íš¨ìœ¨í™”] find() ëŒ€ì‹  ì €ì¥ëœ currentWord ì‚¬ìš©
            const isCorrect = (selectedAnswer === currentWord.ko);

            handleAnswer(isCorrect, selectedButton);
        }

        function handleAnswer(isCorrect, selectedButton) {
            // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
            DOM.optionButtons.forEach(btn => btn.disabled = true);
            
            // [íš¨ìœ¨í™”] find() ëŒ€ì‹  ì €ì¥ëœ currentWord ì‚¬ìš©
            const correctAnswer = currentWord.ko;

            if (isCorrect) {
                gameState.score++;
                selectedButton.classList.remove('bg-gray-100', 'hover:bg-indigo-50', 'hover:border-indigo-300', 'border-gray-200');
                selectedButton.classList.add('btn-correct', 'text-white');
            } else {
                gameState.lives--;
                if (selectedButton) { // ì‹œê°„ ì´ˆê³¼ê°€ ì•„ë‹Œ í´ë¦­ ì˜¤ë‹µ
                    selectedButton.classList.remove('bg-gray-100', 'hover:bg-indigo-50', 'hover:border-indigo-300', 'border-gray-200');
                    selectedButton.classList.add('btn-wrong', 'text-white');
                } else { // ì‹œê°„ ì´ˆê³¼
                    DOM.timerBar.style.backgroundColor = '#ef4444'; // red-500
                }

                // ì •ë‹µ ë²„íŠ¼ í‘œì‹œ ë° ë‚˜ë¨¸ì§€ ë²„íŠ¼ ë¹„í™œì„±í™”
                DOM.optionButtons.forEach(btn => {
                    if (btn.dataset.answer === correctAnswer) {
                        btn.classList.remove('bg-gray-100', 'hover:bg-indigo-50', 'hover:border-indigo-300', 'border-gray-200');
                        btn.classList.add('bg-green-500', 'text-white');
                    } else if (btn !== selectedButton) {
                        // [ë ˆì´ì•„ì›ƒ ìˆ˜ì •] ì„ íƒ ì•ˆ ëœ ë‚˜ë¨¸ì§€ ë²„íŠ¼ë“¤
                        btn.classList.add('opacity-50'); 
                    }
                });
            }

            updateScoreAndLives();

            // 1.5ì´ˆ í›„ ë‹¤ìŒ
            setTimeout(() => {
                if (gameState.lives <= 0) {
                    gameOver(false); // ìƒëª… ì†Œì§„
                } else {
                    nextQuestion();
                }
            }, 1500);
        }

        function updateScoreAndLives() {
            // [íš¨ìœ¨í™”] gameState ê°ì²´ ì‚¬ìš©
            DOM.scoreDisplay.textContent = `${gameState.score} / ${selectedDayWords.length}`;
            
            let hearts = '';
            for (let i = 0; i < 3; i++) {
                if (i < gameState.lives) {
                    hearts += `<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>`;
                } else {
                    hearts += `<svg class="w-6 h-6 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>`;
                }
            }
            DOM.livesDisplay.innerHTML = hearts;
        }

        function gameOver(isWin) {
            showScreen('gameover');
            // [íš¨ìœ¨í™”] gameState ê°ì²´ ì‚¬ìš©
            DOM.finalScore.textContent = `${gameState.score} / ${selectedDayWords.length}`;
            
            if (isWin) {
                DOM.gameOverTitle.textContent = "ğŸ‰ Day ì™„ë£Œ! ğŸ‰";
                DOM.gameOverTitle.classList.remove('text-red-600');
                DOM.gameOverTitle.classList.add('text-green-600');
            } else {
                DOM.gameOverTitle.textContent = "ê²Œì„ ì˜¤ë²„!";
                DOM.gameOverTitle.classList.remove('text-green-600');
                DOM.gameOverTitle.classList.add('text-red-600');
            }

            // ì ìˆ˜ ì €ì¥
            saveScoreToLeaderboard();
        }

        // --- 8. ê´€ë¦¬ì ê¸°ëŠ¥ ---
        
        async function handleAdminClear() {
            const password = DOM.adminPassword.value;
            if (password !== ADMIN_PASSWORD) {
                showError("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                DOM.adminPassword.value = "";
                return;
            }
            
            DOM.adminSubmitButton.disabled = true;
            DOM.adminSubmitButton.textContent = "ì‚­ì œ ì¤‘...";
            
            try {
                await clearLeaderboard();
                showMessage("ë¦¬ë”ë³´ë“œ ê¸°ë¡ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", true);
                DOM.adminPassword.value = "";
                DOM.adminPanel.classList.add('hidden');
            } catch (error) {
                console.error("ë¦¬ë”ë³´ë“œ ì‚­ì œ ì˜¤ë¥˜:", error);
                showError("ë¦¬ë”ë³´ë“œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                DOM.adminSubmitButton.disabled = false;
                DOM.adminSubmitButton.textContent = "ë¦¬ë”ë³´ë“œ ê¸°ë¡ ì‚­ì œ";
            }
        }
        
        async function clearLeaderboard() {
            if (!db || !isAuthReady) {
                throw new Error("Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
            const collectionPath = "leaderboard";
            const q = query(collection(db, collectionPath));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                return; // ì‚­ì œí•  ê²ƒì´ ì—†ìŒ
            }

            // Batch Writeë¡œ í•œ ë²ˆì— ì‚­ì œ
            const batch = writeBatch(db);
            querySnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            console.log(`ë¦¬ë”ë³´ë“œ ê¸°ë¡ ${querySnapshot.size}ê°œ ì‚­ì œ ì™„ë£Œ.`);
        }

        // --- 9. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

        // UI í™”ë©´ ì „í™˜
        function showScreen(screenName) {
            [DOM.startScreen, DOM.gameScreen, DOM.gameOverScreen].forEach(screen => {
                if (screen.id === `${screenName}-screen`) {
                    screen.classList.remove('hidden');
                } else {
                    screen.classList.add('hidden');
                }
            });
        }
        
        // ë°°ì—´ ì„ê¸° (Fisher-Yates Shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // "XX ì „" ì‹œê°„ í¬ë§·
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "ë…„ ì „";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "ë‹¬ ì „";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "ì¼ ì „";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "ì‹œê°„ ì „";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "ë¶„ ì „";
            return "ë°©ê¸ˆ ì „";
        }

        // ì•Œë¦¼ì°½ (ì˜¤ë¥˜)
        function showError(message) {
            DOM.messageTitle.textContent = "ì˜¤ë¥˜!";
            DOM.messageBody.textContent = message;
            DOM.messageBox.className = "fixed top-5 left-1/2 -translate-x-1/2 w-11/12 max-w-md bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50";
            DOM.messageBox.classList.remove('hidden');
            // ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡ setTimeout ì œê±°
        }
        
        // ì•Œë¦¼ì°½ (ì„±ê³µ/ì¼ë°˜)
        function showMessage(message, isSuccess = false) {
            DOM.messageTitle.textContent = isSuccess ? "ì„±ê³µ!" : "ì•Œë¦¼";
            DOM.messageBody.textContent = message;
            DOM.messageBox.className = `fixed top-5 left-1/2 -translate-x-1/2 w-11/12 max-w-md ${isSuccess ? 'bg-green-100 border-green-400 text-green-700' : 'bg-blue-100 border-blue-400 text-blue-700'} px-4 py-3 rounded-lg shadow-lg z-50`;
            DOM.messageBox.classList.remove('hidden');
            setTimeout(() => DOM.messageBox.classList.add('hidden'), 3000);
        }

    </script>
</body>
</html>
