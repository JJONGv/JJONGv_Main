<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day별 영단어 4지선다 게임 (Sheets 연동)</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter 폰트 기본 적용 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 타이머 바 애니메이션 (5초로 변경) */
        @keyframes shrink {
            from { width: 100%; }
            to { width: 0%; }
        }
        .timer-bar-animate {
            animation: shrink 5s linear forwards;
        }
        
        /* 버튼 클릭 시 피드백 애니메이션 (추가) */
        .btn-correct {
            animation: flash-green 0.5s;
            background-color: #22c55e !important; /* green-500 */
            color: white !important;
            transform: scale(1.03);
        }
        .btn-wrong {
            animation: flash-red 0.5s;
            background-color: #ef4444 !important; /* red-500 */
            color: white !important;
        }
        @keyframes flash-green {
            0%, 100% { transform: scale(1.03); }
            50% { transform: scale(1.08); }
        }
        @keyframes flash-red {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        /* 기본 버튼 스타일 (회색) */
        .btn-default {
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
        }
        .btn-default:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="game-container" class="w-full max-w-md mx-auto bg-white shadow-2xl rounded-2xl p-6 transition-all duration-300">

        <!-- 시작 화면 -->
        <div id="start-screen" class="text-center">
            <h1 class="text-3xl font-bold text-indigo-600 mb-4">영단어 4지선다 게임!</h1>
            <p class="text-gray-600 mb-6">Day를 선택하고, 영단어의 뜻을 맞춰보세요.</p>
            
            <div class="mb-8">
                <label for="day-selector" class="block text-sm font-medium text-gray-700 mb-2">학습할 Day를 선택하세요:</label>
                <select id="day-selector" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <!-- JS로 채워집니다 -->
                    <option>단어 로드 중...</option>
                </select>
            </div>

            <button id="start-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform duration-200 hover:scale-105" disabled>
                데이터 로딩 중...
            </button>
            <p id="loading-error" class="text-red-500 text-sm mt-4"></p>
        </div>

        <!-- 게임 중 화면 (hidden) -->
        <div id="game-screen" class="hidden">
            <!-- (이하 게임 화면 HTML은 이전과 동일) -->
            <!-- 1. 헤더: 점수와 생명 -->
            <div class="flex justify-between items-center mb-4">
                <div class="text-lg">
                    <span class="font-bold text-indigo-600">맞춘 개수</span>
                    <span id="score" class="text-2xl font-bold ml-2">0</span>
                </div>
                <div id="lives" class="flex space-x-1">
                    <svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                    <svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                    <svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                </div>
            </div>
            <!-- 2. 타이머 바 -->
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6 overflow-hidden">
                <div id="timer-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-100"></div>
            </div>
            <!-- 3. 문제 (영단어) -->
            <div class="text-center mb-8">
                <p class="text-gray-600 text-lg mb-2">다음 영단어의 뜻은?</p>
                <h2 id="question-word" class="text-4xl font-bold text-gray-800">Apple</h2>
            </div>
            <!-- 4. 선택지 (4지선다 한글 뜻) -->
            <div id="options-grid" class="grid grid-cols-2 gap-4">
                <button class="option-btn btn-default font-semibold py-4 px-4 rounded-lg text-lg transition-transform duration-200 hover:scale-105"></button>
                <button class="option-btn btn-default font-semibold py-4 px-4 rounded-lg text-lg transition-transform duration-200 hover:scale-105"></button>
                <button class="option-btn btn-default font-semibold py-4 px-4 rounded-lg text-lg transition-transform duration-200 hover:scale-105"></button>
                <button class="option-btn btn-default font-semibold py-4 px-4 rounded-lg text-lg transition-transform duration-200 hover:scale-105"></button>
            </div>
        </div>

        <!-- 게임 오버 화면 (hidden) -->
        <div id="game-over-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-red-600 mb-4">게임 오버!</h2>
            <p class="text-gray-600 text-xl mb-6">
                최종 결과: <span id="final-score" class="font-bold text-2xl">0</span>
            </p>
            <button id="restart-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform duration-200 hover:scale-105">
                다른 Day 도전하기
            </button>
        </div>

    </div>

    <script>
        // ##################################################
        // ### 1. Google Sheets 설정 ###
        // ##################################################
        // 2단계에서 복사한 '웹에 게시' URL을 이 "" 안에 붙여넣으세요.
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQU4mlCRTqgUmcZa_Fr28WUomiGWmGTR18WwHXJpwfNhx43Iejb1CA2Jg-pOFgrFbBztWEMOj9HR8-i/pub?gid=0&single=true&output=csv";
        
        // ##################################################
        // ### 게임 로직 (Google Sheets 연동) ###
        // ##################################################

        let globalWordData = {}; // 불러온 단어 데이터를 저장할 객체
        // allWordsList (전체 단어 목록)은 더 이상 필요하지 않으므로 제거합니다.
        let selectedDayWords = []; // 게임에 사용할 단어 목록 (순서 섞음)
        let currentWordIndex = 0;
        let score = 0;
        let lives = 3;
        let timerId; // 타이머 ID
        let isClickable = true; // 중복 클릭 방지

        // --- 2. HTML 요소 가져오기 ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverScreen = document.getElementById('game-over-screen');

        const daySelector = document.getElementById('day-selector');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const loadingError = document.getElementById('loading-error');
        
        const scoreDisplay = document.getElementById('score');
        const livesDisplay = document.getElementById('lives');
        const questionWordDisplay = document.getElementById('question-word');
        const timerBar = document.getElementById('timer-bar');

        const optionsGrid = document.getElementById('options-grid');
        const optionButtons = document.querySelectorAll('.option-btn');
        const finalScoreDisplay = document.getElementById('final-score');

        // --- 3. 유틸리티 함수 ---
        
        // 배열 섞기 (Fisher-Yates Shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // CSV 텍스트를 파싱하여 WORD_DATA 객체 형식으로 변환
        function parseCSV(csvText) {
            const data = {};
            const lines = csvText.split('\n');
            
            // CSV 파싱 시 첫 번째 줄(헤더)을 건너뛰도록 1부터 시작 (선택 사항)
            // Google Sheets '웹에 게시'는 헤더를 포함하지 않으므로 0부터 시작이 맞습니다.
            lines.forEach(line => {
                const parts = line.split(',');
                
                // [수정됨] 쉼표가 3개 이상인 경우(C열에 쉼표가 포함된 경우) 처리
                if (parts.length >= 3) {
                    // A열: Day, B열: en
                    const day = parts[0].trim();
                    const en = parts[1].trim();
                    
                    // [수정됨] C열 이후의 모든 부분을 다시 쉼표로 합쳐서 ko로 만듦
                    let ko = parts.slice(2).join(',').trim();
                    
                    // [수정됨] Google Sheets가 CSV로 만들 때 추가하는 앞뒤 큰따옴표 제거
                    if (ko.startsWith('"') && ko.endsWith('"')) {
                        ko = ko.substring(1, ko.length - 1);
                    }
                    
                    if (day && en && ko) {
                        if (!data[day]) {
                            data[day] = [];
                        }
                        data[day].push({ ko: ko, en: en });
                    }
                }
            });
            return data;
        }

        // Google Sheet에서 단어 데이터 불러오기
        async function loadWordsFromGoogleSheet() {
            if (!GOOGLE_SHEET_CSV_URL || GOOGLE_SHEET_CSV_URL === "YOUR_PUBLISHED_GOOGLE_SHEET_CSV_URL_HERE") {
                console.error("Google Sheet URL이 설정되지 않았습니다.");
                loadingError.textContent = "오류: Google Sheet URL이 설정되지 않았습니다.";
                startButton.textContent = "설정 오류";
                return null;
            }
            
            try {
                // Google Apps Script 프록시를 사용하지 않고 직접 CSV를 fetch
                // 'no-cors' 모드는 응답 내용을 읽을 수 없으므로 사용하지 않습니다.
                // Google Sheets의 '웹에 게시' 기능은 CORS를 허용합니다.
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                return parseCSV(csvText);

            } catch (e) {
                console.error("단어 로드 실패:", e);
                loadingError.textContent = "단어 로드 실패. URL을 확인하세요.";
                startButton.textContent = "로드 실패";
                return null;
            }
        }

        // Day 선택 옵션 채우기 (불러온 데이터 기반)
        function initializeWordData(wordData) {
            // allWordsList 관련 코드를 제거합니다.
            daySelector.innerHTML = ''; // 선택창 초기화 (로딩 중... 옵션 제거)
            
            Object.keys(wordData).forEach(day => {
                const words = wordData[day];
                const wordCount = words.length;
                
                if (wordCount >= 4) { // 4개 이상의 단어가 있는 Day만 선택 가능
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = `${day} (단어 ${wordCount}개)`;
                    daySelector.appendChild(option);
                } else if (wordCount > 0) { // 단어는 있으나 4개 미만인 경우
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = `${day} (단어 ${wordCount}개, 4지선다 불가)`;
                    option.disabled = true;
                    daySelector.appendChild(option);
                }
                // wordCount가 0이면 아무것도 표시하지 않음
            });

            if (daySelector.options.length === 0) {
                 const option = document.createElement('option');
                 option.textContent = '시트에 4개 이상의 단어가 있는 Day가 없습니다.';
                 option.disabled = true;
                 daySelector.appendChild(option);
                 startButton.disabled = true;
                 startButton.textContent = '학습 불가';
            } else {
                // 4지선다 구성이 불가능할 경우 (allWordsList.length < 4) 체크 제거
                // 선택 가능한 Day가 하나라도 있으면 시작 버튼 활성화
                const hasSelectableOption = Array.from(daySelector.options).some(opt => !opt.disabled);
                
                if (hasSelectableOption) {
                    startButton.disabled = false;
                    startButton.textContent = '학습 시작';
                } else {
                    // 모든 Day가 있지만 4개 미만이라 비활성화된 경우
                     startButton.disabled = true;
                     startButton.textContent = '학습 불가';
                }
            }
        }

        // --- 4. 게임 로직 (이전과 동일) ---

        // 게임 시작
        function startGame() {
            const selectedDay = daySelector.value;
            if (!selectedDay || !globalWordData[selectedDay]) return;

            score = 0;
            lives = 3;
            currentWordIndex = 0;
            isClickable = true;
            
            // 선택한 Day의 단어 목록 복사 및 섞기
            selectedDayWords = [...globalWordData[selectedDay]];
            shuffleArray(selectedDayWords);
            
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            updateScoreAndLives();
            nextQuestion();
        }

        // 다음 문제 출제
        function nextQuestion() {
            // [수정됨] 모든 단어를 다 풀었는지 확인
            if (currentWordIndex >= selectedDayWords.length) {
                // [수정됨] 모든 단어를 다 풀었으면 게임 오버 호출
                gameOver();
                return; // 함수 종료
            }

            const currentWord = selectedDayWords[currentWordIndex];
            
            questionWordDisplay.textContent = currentWord.en;
            const options = generateOptions(currentWord.ko);

            optionButtons.forEach((button, index) => {
                button.textContent = options[index];
                button.dataset.answer = options[index];
                button.disabled = false;
                button.className = 'option-btn btn-default font-semibold py-4 px-4 rounded-lg text-lg transition-transform duration-200 hover:scale-105';
            });
            
            isClickable = true;
            startTimer();
            currentWordIndex++;
        }

        // 4개의 선택지 생성 (정답 1 + 오답 3)
        function generateOptions(correctKoreanAnswer) {
            let options = [correctKoreanAnswer];
            
            // [수정됨] allWordsList 대신 'selectedDayWords' (현재 Day 단어 목록) 사용
            let incorrectWords = selectedDayWords
                                .map(word => word.ko)
                                .filter(ko => ko !== correctKoreanAnswer);
            
            shuffleArray(incorrectWords);
            
            let incorrectOptions = new Set();
            // initializeWordData에서 Day별 단어 수가 4개 이상임을 보장했으므로
            // incorrectWords에는 항상 3개 이상의 오답이 있습니다.
            while (incorrectOptions.size < 3) {
                if (incorrectWords.length > 0) {
                    incorrectOptions.add(incorrectWords.pop());
                } else {
                    // (비상시) 중복된 한글 뜻 등으로 인해 오답 풀이 부족할 경우
                    incorrectOptions.add(`오답${incorrectOptions.size + 1}`);
                }
            }

            options.push(...Array.from(incorrectOptions));
            shuffleArray(options);
            return options;
        }

        // 타이머 시작
        function startTimer() {
            clearTimeout(timerId);
            timerBar.classList.remove('timer-bar-animate');
            void timerBar.offsetWidth;
            timerBar.classList.add('timer-bar-animate');
            timerBar.style.backgroundColor = '#22c55e';

            timerId = setTimeout(() => {
                if (isClickable) {
                    handleAnswer(false, null);
                }
            }, 5000);
        }

        // 정답 확인
        function checkAnswer(event) {
            if (!isClickable) return;
            isClickable = false;
            
            clearTimeout(timerId);
            timerBar.classList.remove('timer-bar-animate');

            const selectedButton = event.target;
            const selectedAnswer = selectedButton.dataset.answer;
            const correctAnswer = selectedDayWords[currentWordIndex - 1].ko;
            
            handleAnswer(selectedAnswer === correctAnswer, selectedButton);
        }

        // 정답/오답 처리
        function handleAnswer(isCorrect, selectedButton) {
            optionButtons.forEach(btn => btn.disabled = true);
            const correctAnswer = selectedDayWords[currentWordIndex - 1].ko;

            if (isCorrect) {
                score++;
                selectedButton.classList.add('btn-correct');
            } else {
                lives--;
                if (selectedButton) {
                    selectedButton.classList.add('btn-wrong');
                } else {
                    timerBar.style.backgroundColor = '#ef4444';
                }
                optionButtons.forEach(btn => {
                    if (btn.dataset.answer === correctAnswer) {
                        btn.classList.add('btn-correct');
                    }
                });
            }

            updateScoreAndLives();

            setTimeout(() => {
                if (lives <= 0) {
                    gameOver();
                } else {
                    nextQuestion();
                }
            }, 1200);
        }

        // 점수 및 생명 UI 업데이트
        function updateScoreAndLives() {
            scoreDisplay.textContent = `${score} / ${selectedDayWords.length}`;
            let hearts = '';
            for (let i = 0; i < 3; i++) {
                if (i < lives) {
                    hearts += `<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>`;
                } else {
                    hearts += `<svg class="w-6 h-6 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>`;
                }
            }
            livesDisplay.innerHTML = hearts;
        }

        // 게임 오버
        function gameOver() {
            gameScreen.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
            finalScoreDisplay.textContent = `${score} / ${selectedDayWords.length}`;
        }

        // 시작 화면으로 돌아가기 (재시작)
        function returnToStart() {
            gameOverScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            // Day 선택창을 다시 채웁니다. (데이터는 이미 globalWordData에 있으므로 다시 로드할 필요 없음)
            initializeWordData(globalWordData);
        }

        // --- 5. 이벤트 리스너 ---
        
        // 페이지 로드 시 Google Sheet에서 데이터 가져오기
        document.addEventListener('DOMContentLoaded', async () => {
            const wordData = await loadWordsFromGoogleSheet();
            if (wordData) {
                globalWordData = wordData; // 전역 변수에 저장
                initializeWordData(wordData); // Day 선택창 채우기
            }
        });
        
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', returnToStart);
        
        optionButtons.forEach(button => {
            button.addEventListener('click', checkAnswer);
        });

    </script>
</body>
</html>
